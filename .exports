#!/bin/bash

#
# System Detection and Base Paths
#
if [[ $OSTYPE == 'darwin'* ]]; then
    export EXTRASPATH="/Users/$USER/Library/Mobile Documents/com~apple~CloudDocs/dotfiles/.extra"
    export IS_MACOS=true
else
    export EXTRASPATH="~/dotfiles/.extra"
    export IS_MACOS=false
fi

#
# Package Managers
#

# Homebrew
if [[ $IS_MACOS == true ]]; then
    # M1/Intel Mac detection
    if [[ $(uname -m) == 'arm64' ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    else
        eval "$(/usr/local/bin/brew shellenv)"
    fi
    export HOMEBREW_NO_ANALYTICS=1
    export HOMEBREW_NO_INSECURE_REDIRECT=1
    export HOMEBREW_CASK_OPTS="--appdir=/Applications"
fi

#
# Development Paths
#

# Base PATH
export PATH="/usr/local/sbin:/usr/local/bin:/usr/bin:/bin:$PATH"

# Custom binaries
export PATH="$HOME/bin:$PATH"

# Dart
export PATH="$PATH":"$HOME/.pub-cache/bin"

# Java
export PATH="$HOME/.jenv/bin:$PATH"
if command -v jenv 1>/dev/null 2>&1; then
    eval "$(jenv init -)"
fi

# PHP (MAMP)
if [[ $IS_MACOS == true ]] && [ -d "/Applications/MAMP" ]; then
    MAMP_LATEST_PHP=$(ls /Applications/MAMP/bin/php/ | sort -n | tail -1)
    export PATH="/Applications/MAMP/bin/php/${MAMP_LATEST_PHP}/bin:$PATH"
fi

# Rust
[[ -f "$HOME/.cargo/env" ]] && source "$HOME/.cargo/env"

#
# Editor Configuration
#

# Set default editor (cascading preference)
export EDITOR=$(command -v subl || command -v code || command -v nvim || command -v vim || command -v vi)
export BUNDLE_EDITOR="${EDITOR}"
export VISUAL="${EDITOR}"

#
# Locale Settings
#

# Prefer US English and use UTF-8
export LANG='en_US.UTF-8'
export LC_ALL='en_US.UTF-8'
export LC_CTYPE='en_US.UTF-8'

#
# Shell Configuration
#

# Don't clear the screen after quitting a manual page
export MANPAGER='less -X'

# Enable colour support
export CLICOLOR=1
export GREP_OPTIONS='--color=auto'
export LSCOLORS='ExGxBxDxCxEgEdxbxgxcxd'

# GPG Configuration
if [[ $IS_MACOS == true ]]; then
    export GPG_TTY=$(tty)
fi

#
# Shell History Configuration
#

# Increase history size
export HISTSIZE='32768'
export HISTFILESIZE="${HISTSIZE}"
export HISTCONTROL='ignoreboth'
export HISTTIMEFORMAT="%d/%m/%y %T "

# Commands to ignore in history
export HISTIGNORE=" *:ls:cd:cd -:pwd:exit:date:* --help:* -h:pony:pony add *:pony update *:pony save *:pony ls:pony ls *"

# Hide the "default interactive shell is now zsh" warning on macOS
export BASH_SILENCE_DEPRECATION_WARNING=1

#
# Language-Specific Settings
#

# Node.js
export NODE_REPL_HISTORY=~/.node_history
export NODE_REPL_HISTORY_SIZE='32768'
export NODE_REPL_MODE='sloppy'
export NODE_OPTIONS='--max-old-space-size=4096'

# Python
export PYTHONIOENCODING='UTF-8'
export PYTHONDONTWRITEBYTECODE=1  # Prevent Python from writing .pyc files
export VIRTUAL_ENV_DISABLE_PROMPT=1  # Custom virtual env prompt handling

# Ruby
export RUBY_CONFIGURE_OPTS="--with-openssl-dir=$(brew --prefix openssl@1.1)"

#
# GUI Applications
#

# Linux HiDPI settings
if [[ $IS_MACOS == false ]]; then
    export GDK_SCALE=1.5
    export GDK_DPI_SCALE=0.5
    export QT_DEVICE_PIXEL_RATIO=1.5
fi

#
# Development Tools
#

# Less
export LESS='-R'
export LESS_TERMCAP_mb=$'\E[1;31m'     # begin blink
export LESS_TERMCAP_md=$'\E[1;36m'     # begin bold
export LESS_TERMCAP_me=$'\E[0m'        # reset bold/blink
export LESS_TERMCAP_so=$'\E[01;44;33m' # begin reverse video
export LESS_TERMCAP_se=$'\E[0m'        # reset reverse video
export LESS_TERMCAP_us=$'\E[1;32m'     # begin underline
export LESS_TERMCAP_ue=$'\E[0m'        # reset underline

# FZF
export FZF_DEFAULT_OPTS="--height 40% --layout=reverse --border"

# Git
export GIT_PS1_SHOWDIRTYSTATE=1
export GIT_PS1_SHOWSTASHSTATE=1
export GIT_PS1_SHOWUNTRACKEDFILES=1
