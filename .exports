#!/bin/bash

#
# System Detection and Base Paths
#
if [[ $OSTYPE == 'darwin'* ]]; then
    export EXTRASPATH="$HOME/Library/Mobile Documents/com~apple~CloudDocs/dotfiles/.extra"
    export IS_MACOS=true
else
    export EXTRASPATH="$HOME/.dotfiles/.extra"
    export IS_MACOS=false
fi

path_prepend() {
    local dir="$1"
    [[ -z "$dir" ]] && return
    case ":${PATH}:" in
        *":${dir}:"*) ;;
        *) PATH="${dir}${PATH:+:${PATH}}" ;;
    esac
}

path_append() {
    local dir="$1"
    [[ -z "$dir" ]] && return
    case ":${PATH}:" in
        *":${dir}:"*) ;;
        *) PATH="${PATH:+${PATH}:}${dir}" ;;
    esac
}

#
# Package Managers
#

# Homebrew
if [[ $IS_MACOS == true ]]; then
    if command -v brew >/dev/null 2>&1; then
        eval "$(brew shellenv)"
    elif [[ -x /opt/homebrew/bin/brew ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ -x /usr/local/bin/brew ]]; then
        eval "$(/usr/local/bin/brew shellenv)"
    elif [[ -z "${DOTFILES_SUPPRESS_BREW_PROMPT:-}" ]]; then
        printf 'Homebrew not detected; install from https://brew.sh for full tooling support\n' >&2
        export DOTFILES_SUPPRESS_BREW_PROMPT=1
    fi

    if command -v brew >/dev/null 2>&1; then
        export HOMEBREW_NO_ANALYTICS=1
        export HOMEBREW_NO_INSECURE_REDIRECT=1
        export HOMEBREW_NO_ENV_HINTS=1
        export HOMEBREW_CASK_OPTS="--appdir=/Applications"
    fi
fi

#
# Development Paths
#

# Base PATH
path_prepend "/bin"
path_prepend "/usr/bin"
path_prepend "/usr/local/bin"
path_prepend "/usr/local/sbin"

# Custom binaries
path_prepend "$HOME/bin"

# Local user Python/pipx binaries
path_prepend "$HOME/.local/bin"

# Dart
path_append "$HOME/.pub-cache/bin"

# Java
path_prepend "$HOME/.jenv/bin"
if command -v jenv >/dev/null 2>&1; then
    eval "$(jenv init -)"
fi

# Ruby (rbenv)
path_prepend "$HOME/.rbenv/bin"
path_prepend "$HOME/.rbenv/shims"

# PHP (MAMP)
if [[ $IS_MACOS == true ]] && [[ -d "/Applications/MAMP/bin/php" ]]; then
    if [[ -z "${MAMP_LATEST_PHP:-}" ]]; then
        MAMP_LATEST_PHP=$(ls /Applications/MAMP/bin/php/ 2>/dev/null | sort -V | tail -1)
    fi
    if [[ -n "$MAMP_LATEST_PHP" ]]; then
        path_prepend "/Applications/MAMP/bin/php/${MAMP_LATEST_PHP}/bin"
    fi
fi

# Rust
[[ -f "$HOME/.cargo/env" ]] && source "$HOME/.cargo/env"

#
# Editor Configuration
#

# Set default editor (cascading preference)
export EDITOR=$(command -v subl || command -v code || command -v nvim || command -v vim || command -v vi)
export BUNDLE_EDITOR="${EDITOR}"
export VISUAL="${EDITOR}"

#
# Locale Settings
#

# Prefer US English and use UTF-8
export LANG='en_US.UTF-8'
export LC_ALL='en_US.UTF-8'
export LC_CTYPE='en_US.UTF-8'

#
# Shell Configuration
#

# Don't clear the screen after quitting a manual page
export MANPAGER='less -X'
export PAGER='less'

# Enable colour support
export CLICOLOR=1
export LSCOLORS='ExGxBxDxCxEgEdxbxgxcxd'

# Improved `ls` colors
export LS_COLORS='no=00:fi=00:di=01;34:ln=01;36:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arj=01;31:*.taz=01;31:*.lzh=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.gz=01;31:*.bz2=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.jpg=01;35:*.jpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.avi=01;35:*.fli=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.ogg=01;35:*.mp3=01;35:*.wav=01;35:'

# GPG Configuration
if [[ $IS_MACOS == true ]]; then
    export GPG_TTY=$(tty)
fi

# Terminal Colors
export TERM="xterm-256color"

# Improved CLI Colors
export CLI_COLOR_ERROR="1;31"
export CLI_COLOR_WARN="1;33"
export CLI_COLOR_SUCCESS="1;32"
export CLI_COLOR_DEBUG="1;34"




#
# Shell History Configuration
#

# Increase history size
export HISTSIZE=1000000
export HISTFILESIZE="${HISTSIZE}"
export HISTCONTROL='ignoreboth'
export HISTTIMEFORMAT="%d/%m/%y %T "

# Commands to ignore in history
export HISTIGNORE=" *:ls:cd:cd -:pwd:exit:date:* --help:* -h:pony:pony add *:pony update *:pony save *:pony ls:pony ls *"

# Hide the "default interactive shell is now zsh" warning on macOS
export BASH_SILENCE_DEPRECATION_WARNING=1

#
# Language-Specific Settings
#

# Node.js
export NODE_REPL_HISTORY=~/.node_history
export NODE_REPL_HISTORY_SIZE='32768'
export NODE_REPL_MODE='sloppy'
export NODE_OPTIONS='--max-old-space-size=4096'
export NPM_CONFIG_FUND=false
# nodenv paths - lazy loading handled in .zshrc
path_prepend "$HOME/.nodenv/bin"
path_prepend "$HOME/.nodenv/shims"

# pnpm
if [[ $IS_MACOS == true ]]; then
    export PNPM_HOME="$HOME/Library/pnpm"
else
    export PNPM_HOME="${XDG_DATA_HOME:-$HOME/.local/share}/pnpm"
fi
path_prepend "$PNPM_HOME"

# Python
export PYTHONIOENCODING='UTF-8'
export PYTHONDONTWRITEBYTECODE=1  # Prevent Python from writing .pyc files
export VIRTUAL_ENV_DISABLE_PROMPT=1  # Custom virtual env prompt handling

# Ruby
if command -v brew >/dev/null 2>&1 && brew ls --versions openssl@1.1 >/dev/null 2>&1; then
    export RUBY_CONFIGURE_OPTS="--with-openssl-dir=$(brew --prefix openssl@1.1)"
fi

#
# GUI Applications
#

# Linux HiDPI settings
if [[ $IS_MACOS == false ]]; then
    export GDK_SCALE=1.5
    export GDK_DPI_SCALE=0.5
    export QT_DEVICE_PIXEL_RATIO=1.5
fi

#
# Development Tools
#

# Less
export LESS='-F -i -J -M -R -W -x4 -X -z-4'
export LESS_TERMCAP_mb=$'\E[01;31m'
export LESS_TERMCAP_md=$'\E[01;31m'
export LESS_TERMCAP_me=$'\E[0m'
export LESS_TERMCAP_se=$'\E[0m'
export LESS_TERMCAP_so=$'\E[01;44;33m'
export LESS_TERMCAP_ue=$'\E[0m'
export LESS_TERMCAP_us=$'\E[01;32m'


# FZF tuned for Tokyo Night palette
export FZF_DEFAULT_OPTS="--height 40% --layout=reverse --border --preview-window=border-left --color=bg+:#1f2335,bg:#1a1b26,spinner:#bb9af7,hl:#ff9e64,fg:#c0caf5,header:#ff9e64,info:#7aa2f7,pointer:#7dcfff,marker:#9ece6a,prompt:#7aa2f7"

# ripgrep config
export RIPGREP_CONFIG_PATH="$HOME/.ripgreprc"

# bat config
export BAT_CONFIG_PATH="$HOME/.config/bat/config"

# Git
export GIT_PS1_SHOWDIRTYSTATE=1
export GIT_PS1_SHOWSTASHSTATE=1
export GIT_PS1_SHOWUNTRACKEDFILES=1

# Docker
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1

# Cursor CLI support (installed via app bundle)
if [[ $IS_MACOS == true ]] && [[ -d /Applications/Cursor.app/Contents/MacOS ]]; then
    path_prepend "/Applications/Cursor.app/Contents/MacOS"
fi

# Go
export GOPATH=$HOME/go
path_append "$GOPATH/bin"

# Java
if command -v /usr/libexec/java_home >/dev/null 2>&1; then
    export JAVA_HOME=$(/usr/libexec/java_home 2>/dev/null)
fi
export GRADLE_USER_HOME=$HOME/.gradle

# Android
export ANDROID_HOME=$HOME/Library/Android/sdk
path_append "$ANDROID_HOME/tools"
path_append "$ANDROID_HOME/platform-tools"

# AWS
export AWS_SDK_LOAD_CONFIG=1

# Make kubectl faster with nocorrect
export KUBECTL_EXTERNAL_DIFF="colordiff -N -u"

export PATH
unset -f path_prepend path_append
